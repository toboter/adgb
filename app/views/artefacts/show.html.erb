<% title @artefact.name %>

<% content_for(:buttons) do %>
  <%= link_to 'Edit', edit_artefact_path(@artefact), class: 'btn btn-warning' if can?(:edit, @artefact) %>
  <%= link_to 'Delete', @artefact, method: :delete, data: { confirm: 'Are you sure?' }, class: 'btn btn-danger' if can?(:destroy, @artefact) %>
<% end if can?(:edit, @artefact) || can?(:destroy, @artefact) %>

<% content_for :head do %>
  <script src="//maps.google.com/maps/api/js?key=<%= Rails.application.secrets.gmaps_api_key %>"></script>
  <script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<% end %>


<div class="row">
  <div class="col-md-6">
    <table class="table table-striped">
      <tbody>
        <%= table_row(@artefact.b_join, 'Grabung Joins') %>
        <%= table_row(@artefact.b_korr, 'Grabung Korrektur') %>
        <%= table_row(@artefact.m_join, 'Museum Joins') %>
        <%= table_row(@artefact.m_korr, 'Museum Korrektur') %>

        <%= table_row(@artefact.kod, 'Code') %>
        <%= table_row(@artefact.grab, 'Grab') %>
        <%= table_row(@artefact.text, 'Text') %>
        <%= table_row(@artefact.sig, 'Sig') %>

        <%= table_row(@artefact.f_obj, 'Beschreibung') %>
        <%= table_row(@artefact.abklatsch, 'Abklatsch') %>
        <%= table_row(@artefact.abguss, 'Abguss') %>
        <%= table_row(@artefact.period, 'Periode') %>
        <%= table_row("#{@artefact.mas1}#{';' if @artefact.mas2 || @artefact.mas3} #{@artefact.mas2}#{';' if @artefact.mas3} #{@artefact.mas3}".html_safe, 'Maße') if @artefact.mas1.present? || @artefact.mas2.present? || @artefact.mas3.present? %>

        <%= table_row(@artefact.fo_tell, 'Tell') %>
        <%= table_row("#{@artefact.fo1} #{@artefact.fo2} #{@artefact.fo3} #{@artefact.fo4}", 'Areal') %>
        <%= table_row(@artefact.fo_text, 'Fundumstände') %>
        <%= table_row("#{@artefact.gr_datum}#{@artefact.gr_jahr}", 'Grabungsdatum') %>
        <%= table_row("<strong>E</strong> #{@artefact.utmx} (#{@artefact.utmxx}) <strong>N</strong> #{@artefact.utmy} (#{@artefact.utmyy})".html_safe, 'UTM') if @artefact.utm? %>

        <%= content_tag :tr do %>
          <th>Photos <small>(position)</small></th>
          <td><%= @artefact.illustrations.map{ |i| "#{(i.photo ? link_to(i.name, i.photo) : i.name)}#{' ('+i.position+')' if i.position}" }.join('; ').html_safe %></td>
        <% end if @artefact.illustrations.any? %>
        <%= content_tag :tr do %>
            <th>Bibliographie: </th>
            <td><%= @artefact.references.map{ |r| r.title }.join('; ') %></td>
        <% end if @artefact.references.any? %>

        <%= table_row(@artefact.inhalt, 'Textinhalt') %>
        <%= table_row(@artefact.arkiv, 'Archiv') %>
        <%= table_row(@artefact.text_in_archiv, 'Text in Archiv') %>
        <%= table_row(@artefact.jahr, 'Jahr') %>
        <%= table_row(@artefact.datum, 'Datum') %>
        <%= table_row(@artefact.zeil2, 'Zeil2') %>
        <%= table_row(@artefact.zeil1, 'Zeil1') %>
        <%= content_tag :tr do %>
          <th>Personen: </th>
          <td><%= @artefact.people.map{|p| "#{p.person}#{' '+p.titel if p.titel.present?}"}.join('; ') %></td>
        <% end if @artefact.people.any? %>
        <%= content_tag :div do %>
          <%= table_row(@artefact.diss, 'Dissov Id') %>
          <%= table_row(@artefact.mus_id, 'Museums Id') %>
          <%= table_row(@artefact.standort, 'Standort') %>
          <%= table_row(@artefact.standort_alt, 'Standort (alt)') %>
        <% end if can? :edit, artefact %>         
      </tbody>
    </table>
  </div>

  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="panel-body">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist">
          <%= content_tag :li, link_to('Map', '#map', aria: {controls: 'map'}, role: 'tab', data: {toggle: 'tab'}), role: 'presentation', class: 'active' %>
          <%= content_tag :li, link_to(fa_icon('photo', text: "Images"), '#images', aria: {controls: 'images'}, role: 'tab', data: {toggle: 'tab'}), role: 'presentation', class: '' %>
          <%= content_tag :li, link_to("Comments <span class='badge'>#{@artefact.root_comments.count}</span>".html_safe, '#comments', aria: {controls: 'comments'}, role: 'tab', data: {toggle: 'tab'}), role: 'presentation', class: '' %>
          <%= content_tag :li, link_to(fa_icon('share-alt', text: "Sharing"), '#sharing', aria: {controls: 'sharing'}, role: 'tab', data: {toggle: 'tab'}), role: 'presentation', class: '' %>
        </ul>

        <div class="tab-content">
          <%= content_tag :div, id: 'map', role: 'tabpanel', class: 'tab-pane active', style: 'padding-top:20px;' do %>
            <%= content_tag :div, style: 'width: 100%;', class: "thumbnail" do %>
              <div id="map-render" style='width: 100%; height: 400px;'></div>
            <% end if @artefact.utm? %>      
          <% end %>

          <%= content_tag :div, id: 'images', role: 'tabpanel', class: 'tab-pane', style: 'padding-top:20px;' do %>
            <div class="row">
              <% for img in @illustrations do %>
                <div class="col-md-6"><%= render 'shared/image_thumb', img: img %></div>
              <% end %>
            </div>
          <% end %>

          <%= content_tag :div, id: 'comments', role: 'tabpanel', class: 'tab-pane' do %>
            <%= commentables_for(@artefact) %>
          <% end %>

          <%= content_tag :div, id: 'sharing', role: 'tabpanel', class: 'tab-pane', style: 'padding-top:10px;' do %>
            <%= shared_with(@artefact) %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<% if @artefact.utm? %>
  <script type="text/javascript">
    handler = Gmaps.build('Google');
    handler.buildMap({
        provider: {
          mapTypeId: google.maps.MapTypeId.SATELLITE
        },
        internal: {
          id: 'map-render'
        }
      },
      function(){
        markers = handler.addMarkers([
          {
            "lat": <%= @artefact.to_lat_lon('38S').lat %>,
            "lng": <%= @artefact.to_lat_lon('38S').lon %>,
            "infowindow": "<%= "#{@artefact.full_entry}#{' ('+@artefact.kod+')' if @artefact.kod}#{', '+@artefact.f_obj if @artefact.f_obj}" %>"
          }
        ]);
        handler.bounds.extendWith(markers);
        handler.fitMapToBounds();
      }
    );
  </script>
<% end %>